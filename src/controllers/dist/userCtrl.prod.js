"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _validation=require("../validation"),_clearStates=_interopRequireDefault(require("../helpers/clearStates"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function ownKeys(s,e){var a,t=Object.keys(s);return Object.getOwnPropertySymbols&&(a=Object.getOwnPropertySymbols(s),e&&(a=a.filter(function(e){return Object.getOwnPropertyDescriptor(s,e).enumerable})),t.push.apply(t,a)),t}function _objectSpread(s){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(a,!0).forEach(function(e){_defineProperty(s,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(a)):ownKeys(a).forEach(function(e){Object.defineProperty(s,e,Object.getOwnPropertyDescriptor(a,e))})}return s}function _defineProperty(e,s,a){return s in e?Object.defineProperty(e,s,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[s]=a,e}function _classCallCheck(e,s){if(!(e instanceof s))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,s){for(var a=0;a<s.length;a++){var t=s[a];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}function _createClass(e,s,a){return s&&_defineProperties(e.prototype,s),a&&_defineProperties(e,a),e}var User=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"getLogin",value:function(){console.log("[getLogin] Display Login Page");var e=_objectSpread({},sharedData,{loginActive:!0,loggedIn:loggedIn});formData&&0!==msgs.length&&(e.username&&(e.username.input=formData.username),e.password&&(e.password.input=formData.password),e.msgs=msgs),this.loadPartials({navbar:"../views/partials/navbar.hbs",notifications:"../views/partials/notifications.hbs"}).then(function(){this.render("../views/users/login.hbs",e).swap(),(0,_clearStates.default)(e)})}},{key:"postLogin",value:function(){var s=this;console.log("[postLogin] Validate User Login");var e=this.params,a=e.username,t=e.password;formData={username:a,password:t},(0,_validation.loginValidation)(formData)?(sharedData.isLoading=!0,this.redirect("#/user/login"),db.login({username:a,password:t}).then(function(e){sessionStorage.setItem("userId",e._id),sessionStorage.setItem("firstname",e.firstname),sessionStorage.setItem("lastname",e.lastname),sessionStorage.setItem("loggedIn",e._kmd.authtoken),loggedIn=!0,msgs.push({msg:"Logged In successully!",class:"alert-success"}),sharedData.isLoading=!1,s.redirect("#/")}).catch(function(e){msgs.push({msg:"Invalid credentials. Please retry your request with correct credentials",class:"alert-danger"}),sharedData.username={},sharedData.username.invalid=!0,sharedData.password={},sharedData.isLoading=!1,s.redirect("#/user/login")})):this.redirect("#/user/login")}},{key:"getSignup",value:function(){console.log("[getSignUp] Display Signup Form");var e=_objectSpread({},sharedData,{signupActive:!0,loggedIn:loggedIn});formData&&0!==msgs.length&&(e.firstname.input=formData.firstname,e.lastname.input=formData.lastname,e.username.input=formData.username,e.password.input=formData.password,e.password2.input=formData.password2,e.msgs=msgs),this.loadPartials({navbar:"../views/partials/navbar.hbs",notifications:"../views/partials/notifications.hbs"}).then(function(){this.render("../views/users/signup.hbs",e).swap(),(0,_clearStates.default)(e)})}},{key:"postSignup",value:function(){var s=this;console.log("[postsignUp] Validate Signup Form");var e=this.params,a=e.firstname,t=e.lastname,r=e.username,n=e.password,o=e.password2;formData={firstname:a,lastname:t,username:r,password2:o,password:n},(0,_validation.signupValidation)(formData)?(console.log("[postSignUp] isValid"),sharedData.isLoading=!0,this.redirect("#/user/signup"),db.signup(_defineProperty({username:r,password:n,firstname:a,lastname:t},"username",r)).then(function(e){console.log(e),msgs.push({msg:"User Created Successfully !",class:"alert-success"}),sharedData.isLoading=!1,s.redirect("#/user/login"),formData={}}).catch(function(e){409===e.status&&(console.log("[postSignUp] isInvalid"),msgs.push({msg:"Invalid credentials. Please retry your request with correct credentials",class:"alert-danger"}),sharedData.firstname={},sharedData.lastname={},sharedData.username={},sharedData.username.invalid=!0,sharedData.password={},sharedData.password2={},sharedData.isLoading=!1,console.log(sharedData),s.redirect("#/user/signup"))})):this.redirect("#/user/signup")}},{key:"getLogout",value:function(){var s=this;console.log("[getLogout] User Logged Out");var e=sessionStorage.getItem("loggedIn");db.logout(e).then(function(e){msgs=[],msgs.push({msg:"Logged out Successfully !",class:"alert-success"}),sessionStorage.removeItem("loggedIn"),sessionStorage.removeItem("userId"),sessionStorage.removeItem("username"),loggedIn=!1,s.redirect("#/user/login")}).catch(function(e){msgs.push({msg:e.statusText,class:"alert-danger"}),s.redirect("#/")})}}]),e}();exports.default=User;